USE Мозаика;
GO

-- 1. Загрузка Поставщиков из XML
DECLARE @ПоставщикиXML XML;
SELECT @ПоставщикиXML = BulkColumn 
FROM OPENROWSET(BULK 'E:\4 курс\УП 02.01\Отчеты\задание 3\Данные\Поставщики.xml', SINGLE_BLOB) AS x;

INSERT INTO Поставщики (тип_поставщика, наименование_компании, инн)
SELECT 
    x.value('(тип_поставщика)[1]', 'NVARCHAR(50)'),
    x.value('(наименование_компании)[1]', 'NVARCHAR(255)'),
    x.value('(инн)[1]', 'NVARCHAR(12)')
FROM @ПоставщикиXML.nodes('/Поставщики/Поставщик') AS t(x);
PRINT 'Поставщики загружены из XML';

-- 2. Загрузка Материалов из XML
DECLARE @МатериалыXML XML;
SELECT @МатериалыXML = BulkColumn 
FROM OPENROWSET(BULK 'E:\4 курс\УП 02.01\Отчеты\задание 3\Данные\Материалы.xml', SINGLE_BLOB) AS x;

INSERT INTO Материалы (тип_материала, наименование_материала, id_поставщика, количество_в_упаковке, единица_измерения, цена_за_единицу, текущий_остаток, минимальный_запас)
SELECT 
    x.value('(тип_материала)[1]', 'NVARCHAR(50)'),
    x.value('(наименование_материала)[1]', 'NVARCHAR(255)'),
    x.value('(id_поставщика)[1]', 'INT'),
    x.value('(количество_в_упаковке)[1]', 'DECIMAL(10,2)'),
    x.value('(единица_измерения)[1]', 'NVARCHAR(20)'),
    x.value('(цена_за_единицу)[1]', 'DECIMAL(15,2)'),
    x.value('(текущий_остаток)[1]', 'DECIMAL(10,2)'),
    x.value('(минимальный_запас)[1]', 'DECIMAL(10,2)')
FROM @МатериалыXML.nodes('/Материалы/Материал') AS t(x);
PRINT 'Материалы загружены из XML';

-- 3. Загрузка Сотрудников из XML
DECLARE @СотрудникиXML XML;
SELECT @СотрудникиXML = BulkColumn 
FROM OPENROWSET(BULK 'E:\4 курс\УП 02.01\Отчеты\задание 3\Данные\Сотрудники.xml', SINGLE_BLOB) AS x;

INSERT INTO Сотрудники (фио, дата_рождения, паспортные_данные, банковские_реквизиты, семейное_положение, дата_приема)
SELECT 
    x.value('(фио)[1]', 'NVARCHAR(255)'),
    x.value('(дата_рождения)[1]', 'DATE'),
    x.value('(паспортные_данные)[1]', 'NVARCHAR(100)'),
    x.value('(банковские_реквизиты)[1]', 'NVARCHAR(255)'),
    x.value('(семейное_положение)[1]', 'NVARCHAR(50)'),
    x.value('(дата_приема)[1]', 'DATE')
FROM @СотрудникиXML.nodes('/Сотрудники/Сотрудник') AS t(x);
PRINT 'Сотрудники загружены из XML';

-- 4. Загрузка Партнеров из XML
DECLARE @ПартнерыXML XML;
SELECT @ПартнерыXML = BulkColumn 
FROM OPENROWSET(BULK 'E:\4 курс\УП 02.01\Отчеты\задание 3\Данные\Партнеры.xml', SINGLE_BLOB) AS x;

INSERT INTO Партнеры (тип_партнера, наименование_компании, юридический_адрес, инн, фио_директора, телефон, email, рейтинг)
SELECT 
    x.value('(тип_партнера)[1]', 'NVARCHAR(50)'),
    x.value('(наименование_компании)[1]', 'NVARCHAR(255)'),
    x.value('(юридический_адрес)[1]', 'NVARCHAR(500)'),
    x.value('(инн)[1]', 'NVARCHAR(12)'),
    x.value('(фио_директора)[1]', 'NVARCHAR(255)'),
    x.value('(телефон)[1]', 'NVARCHAR(20)'),
    x.value('(email)[1]', 'NVARCHAR(255)'),
    x.value('(рейтинг)[1]', 'DECIMAL(3,2)')
FROM @ПартнерыXML.nodes('/Партнеры/Партнер') AS t(x);
PRINT 'Партнеры загружены из XML';

-- 5. Загрузка Продукции из XML
DECLARE @ПродукцияXML XML;
SELECT @ПродукцияXML = BulkColumn 
FROM OPENROWSET(BULK 'E:\4 курс\УП 02.01\Отчеты\задание 3\Данные\Продукция.xml', SINGLE_BLOB) AS x;

INSERT INTO Продукция (артикул, тип_продукции, наименование_продукции, описание, минимальная_цена_партнера, размер_упаковки, вес_без_упаковки, вес_с_упаковкой, номер_стандарта, время_изготовления_часы, себестоимость, номер_цеха, количество_рабочих)
SELECT 
    x.value('(артикул)[1]', 'NVARCHAR(50)'),
    x.value('(тип_продукции)[1]', 'NVARCHAR(50)'),
    x.value('(наименование_продукции)[1]', 'NVARCHAR(255)'),
    x.value('(описание)[1]', 'NVARCHAR(MAX)'),
    x.value('(минимальная_цена_партнера)[1]', 'DECIMAL(15,2)'),
    x.value('(размер_упаковки)[1]', 'NVARCHAR(100)'),
    x.value('(вес_без_упаковки)[1]', 'DECIMAL(8,2)'),
    x.value('(вес_с_упаковкой)[1]', 'DECIMAL(8,2)'),
    x.value('(номер_стандарта)[1]', 'NVARCHAR(100)'),
    x.value('(время_изготовления_часы)[1]', 'INT'),
    x.value('(себестоимость)[1]', 'DECIMAL(15,2)'),
    x.value('(номер_цеха)[1]', 'INT'),
    x.value('(количество_рабочих)[1]', 'INT')
FROM @ПродукцияXML.nodes('/Продукция/Продукт') AS t(x);
PRINT 'Продукция загружена из XML';

-- Проверяем загрузку
SELECT 'Поставщики' AS Таблица, COUNT(*) AS Количество FROM Поставщики
UNION ALL SELECT 'Материалы', COUNT(*) FROM Материалы
UNION ALL SELECT 'Сотрудники', COUNT(*) FROM Сотрудники
UNION ALL SELECT 'Партнеры', COUNT(*) FROM Партнеры
UNION ALL SELECT 'Продукция', COUNT(*) FROM Продукция;
GO