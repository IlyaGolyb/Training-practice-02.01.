USE Мозаика;
GO

-- 1. Заполняем таблицу dbo.Заявки
PRINT 'Заполняем таблицу dbo.Заявки...';

INSERT INTO dbo.Заявки (
    id_заявки,
    id_партнера,
    id_менеджера,
    дата_создания,
    статус,
    сумма_предоплаты,
    общая_сумма,
    размер_скидки,
    дата_выполнения,
    дата_предоплаты,
    дата_полной_оплаты,
    способ_доставки,
    дата_отгрузки,
    результат_проверки_качества,
    дата_автоотмены,
    уведомление_отправлено
)
VALUES
-- Заявка 1: Оптовая заявка от СтройМаркет
(1, 1, 1, '2024-01-15 10:30:00', 'В обработке', 50000.00, 250000.00, 5.00, '2024-02-15', 
 '2024-01-16 14:20:00', NULL, 'Самовывоз', NULL, NULL, NULL, 1),

-- Заявка 2: Розничная заявка от КерамикаДом
(2, 2, 1, '2024-01-20 09:15:00', 'В производстве', 15000.00, 75000.00, 3.00, '2024-02-10', 
 '2024-01-21 11:45:00', NULL, 'Доставка курьером', NULL, 'Пройдена первичная проверка', NULL, 1),

-- Заявка 3: Новая заявка от СтройМаркет
(3, 1, 1, '2024-01-25 14:00:00', 'Новая', NULL, 120000.00, NULL, NULL, 
 NULL, NULL, NULL, NULL, NULL, NULL, 0),

-- Заявка 4: Выполненная заявка от КерамикаДом
(4, 2, 1, '2023-12-10 11:20:00', 'Выполнена', 30000.00, 150000.00, 7.00, '2024-01-10', 
 '2023-12-11 16:30:00', '2024-01-05 10:15:00', 'Транспортная компания', '2024-01-09 09:00:00', 
 'Вся продукция соответствует стандартам качества', NULL, 1),

-- Заявка 5: Отмененная заявка от СтройМаркет
(5, 1, 1, '2024-01-05 16:45:00', 'Отменена', 0.00, 80000.00, NULL, NULL, 
 NULL, NULL, NULL, NULL, NULL, '2024-01-20 23:59:59', 1);

PRINT 'Добавлено ' + CAST(@@ROWCOUNT AS NVARCHAR(10)) + ' записей в dbo.Заявки';
GO

-- 2. Заполняем таблицу dbo.ПозицииЗаявки
PRINT 'Заполняем таблицу dbo.ПозицииЗаявки...';

INSERT INTO dbo.ПозицииЗаявки (
    id_позиции,
    id_заявки,
    id_продукции,
    количество,
    цена_за_единицу,
    дата_производства,
    статус
)
VALUES
-- Позиции для заявки 1 (СтройМаркет - KER-001 и KER-002)
(1, 1, 1, 100, 900.00, '2024-02-10', 'В производстве'),
(2, 1, 2, 50, 750.00, '2024-02-12', 'В производстве'),

-- Позиции для заявки 2 (КерамикаДом - KER-001 и KER-002)
(3, 2, 1, 30, 920.00, '2024-02-05', 'Готово'),
(4, 2, 2, 20, 780.00, '2024-02-03', 'Готово'),

-- Позиции для заявки 3 (СтройМаркет - KER-001 и KER-002)
(5, 3, 1, 60, 880.00, NULL, 'В ожидании'),
(6, 3, 2, 40, 730.00, NULL, 'В ожидании'),

-- Позиции для заявки 4 (КерамикаДом - KER-001 и KER-002)
(7, 4, 1, 80, 910.00, '2024-01-08', 'Отгружено'),
(8, 4, 2, 35, 760.00, '2024-01-06', 'Отгружено'),

-- Позиции для заявки 5 (СтройМаркет - KER-001 и KER-002)
(9, 5, 1, 40, 890.00, NULL, 'Отменено'),
(10, 5, 2, 25, 740.00, NULL, 'Отменено');

PRINT 'Добавлено ' + CAST(@@ROWCOUNT AS NVARCHAR(10)) + ' записей в dbo.ПозицииЗаявки';
GO

-- 3. Заполняем таблицу dbo.ПроизводственныеЗадания
PRINT 'Заполняем таблицу dbo.ПроизводственныеЗадания...';

INSERT INTO dbo.ПроизводственныеЗадания (
    id_задания,
    id_заявки,
    id_мастера,
    дата_создания,
    срок_выполнения,
    статус,
    приоритет
)
VALUES
-- Задание для заявки 1 (СтройМаркет)
(1, 1, 1, '2024-01-16 08:00:00', '2024-02-15', 'В работе', 1),

-- Задание для заявки 2 (КерамикаДом)
(2, 2, 2, '2024-01-22 09:30:00', '2024-02-10', 'Выполнено', 2),

-- Задание для заявки 4 (КерамикаДом - выполненная)
(3, 4, 1, '2023-12-12 10:15:00', '2024-01-10', 'Выполнено', 1),

-- Задание для заявки 3 (СтройМаркет - в ожидании)
(4, 3, 2, '2024-01-26 14:30:00', '2024-02-25', 'Запланировано', 3);

PRINT 'Добавлено ' + CAST(@@ROWCOUNT AS NVARCHAR(10)) + ' записей в dbo.ПроизводственныеЗадания';
GO

-- 4. Проверяем загрузку всех таблиц
PRINT 'Проверяем количество записей в таблицах:';
SELECT 'Заявки' AS Таблица, COUNT(*) AS Количество FROM dbo.Заявки
UNION ALL 
SELECT 'ПозицииЗаявки', COUNT(*) FROM dbo.ПозицииЗаявки
UNION ALL 
SELECT 'ПроизводственныеЗадания', COUNT(*) FROM dbo.ПроизводственныеЗадания
UNION ALL 
SELECT 'Поставщики', COUNT(*) FROM Поставщики
UNION ALL 
SELECT 'Материалы', COUNT(*) FROM Материалы
UNION ALL 
SELECT 'Сотрудники', COUNT(*) FROM Сотрудники
UNION ALL 
SELECT 'Партнеры', COUNT(*) FROM Партнеры
UNION ALL 
SELECT 'Продукция', COUNT(*) FROM Продукция
ORDER BY Таблица;
GO

-- 5. Демонстрация связей между данными
PRINT 'Демонстрация связей в данных:';
PRINT '========================================';

-- Показываем заявки с информацией о партнерах и продукции
SELECT 
    'Заявки с партнерами' AS Описание;
SELECT 
    z.id_заявки,
    p.наименование_компании AS Партнер,
    z.дата_создания,
    z.статус,
    z.общая_сумма,
    CASE 
        WHEN z.способ_доставки IS NOT NULL THEN z.способ_доставки
        ELSE 'Не указан'
    END AS Доставка
FROM dbo.Заявки z
JOIN Партнеры p ON z.id_партнера = p.id_партнера
ORDER BY z.дата_создания DESC;
GO

PRINT '';
SELECT 
    'Позиции заявок с продукцией' AS Описание;
SELECT 
    pz.id_позиции,
    pz.id_заявки,
    pr.наименование_продукции AS Продукция,
    pr.артикул,
    pz.количество,
    pz.цена_за_единицу,
    pz.количество * pz.цена_за_единицу AS Сумма_позиции,
    pz.статус
FROM dbo.ПозицииЗаявки pz
JOIN Продукция pr ON pz.id_продукции = pr.id_продукции
ORDER BY pz.id_заявки, pz.id_позиции;
GO

PRINT '';
SELECT 
    'Производственные задания' AS Описание;
SELECT 
    pz.id_задания,
    pz.id_заявки,
    pz.дата_создания AS Дата_создания_задания,
    pz.срок_выполнения,
    DATEDIFF(DAY, pz.дата_создания, pz.срок_выполнения) AS Дней_на_выполнение,
    pz.статус AS Статус_задания,
    pz.приоритет,
    z.статус AS Статус_заявки
FROM dbo.ПроизводственныеЗадания pz
JOIN dbo.Заявки z ON pz.id_заявки = z.id_заявки
ORDER BY pz.приоритет, pz.срок_выполнения;
GO

PRINT '';
SELECT 
    'Сводная информация по заявкам' AS Описание;
SELECT 
    z.id_заявки,
    p.наименование_компании AS Партнер,
    z.статус AS Статус_заявки,
    COUNT(pz.id_позиции) AS Количество_позиций,
    SUM(pz.количество) AS Общее_количество_продукции,
    z.общая_сумма,
    MIN(pz.дата_производства) AS Первая_дата_производства,
    MAX(pz.дата_производства) AS Последняя_дата_производства
FROM dbo.Заявки z
JOIN Партнеры p ON z.id_партнера = p.id_партнера
LEFT JOIN dbo.ПозицииЗаявки pz ON z.id_заявки = pz.id_заявки
GROUP BY z.id_заявки, p.наименование_компании, z.статус, z.общая_сумма
ORDER BY z.id_заявки;
GO

PRINT 'Скрипт успешно выполнен! Все таблицы заполнены.';